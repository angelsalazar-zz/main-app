<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/slider-parent/slider-parent.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="model-el.html">
<link rel="import" href="model-viewer.html">

<dom-module id="main-app">
   <template>
     <style is="custom-style">
         :host {
             display: block;
         }
         paper-drawer-panel {
             --paper-drawer-panel-main-container: {
                 background-color: #e5e5e5;
             };
         }
         paper-drawer-panel {
             --paper-drawer-panel-left-drawer-container: {
                 background-color: white;
             };
         }
         paper-drawer-panel paper-header-panel .slider-parent-wrapper{
             margin: 25px 10px;
         }
         .overlay{
             position: absolute;
             top:0;
             bottom: 0;
             left: 0;
             right: 0;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             background: #fff;
         }
         .content{
           display: flex;
           flex-direction: column;
           padding: 10px;
           width: calc(100%-10px);
         }
         .boxes-wrapper{
           display: flex;
           flex-wrap: wrap;
         }
         h1,h2,h3,h4,h5{
           margin: 0;
           padding: 0;
         }
    </style>
       <iron-ajax
            auto
            url="../seed/objects.json"
            handle-as="json"
            on-response="_handleResponse"
            on-error="_handleError"
            debounce-duration="3000"
            ></iron-ajax>
       <paper-drawer-panel id="panel">
           <paper-header-panel drawer>
             <template is="dom-if"  if="{{ready}}" >
               <template id="repeat" is="dom-repeat" delay=1000 items="{{parametersCollection}}">
                  <div class="slider-parent-wrapper">
                      <slider-parent objects="{{item.collection}}"></slider-parent>
                  </div>
               </template>
             </template>
            </paper-header-panel>
            <paper-header-panel main>
                <paper-toolbar>
                    <paper-icon-button icon="{{iconMenu}}" on-tap="_toggleSlidersContainer"></paper-icon-button>
                    <div>Models</div>
                </paper-toolbar>
                <div class="content">
                    <model-viewer id="viewer" model="{{currentModel}}"></model-viewer>
                    <div class="boxes-wrapper">
                      <template is="dom-repeat" items="{{models}}" as="model">
                        <model-el model='{{model}}' on-tap="openModel"></model-el>
                      </template>
                    </div>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>

        <!-- loading -->
        <div class="overlay" hidden$="[[!isLoading]]">
            <paper-spinner active="[[isLoading]]"></paper-spinner>
        </div>
  </template>
  <script>
      Polymer({
          is: 'main-app',
          properties: {
              iconMenu:{
                  type: String,
                  value:"arrow-back"
              },
              isLoading:{
                  type: Boolean,
                  value: true,
                  notify:true
              },
              ready:{
                  type: Boolean,
                  value:false,
                  notify:true
              },
              visible:{
                  type: Boolean,
                  value: true
              },
              parametersCollection:{
                  type:Array,
                  value:function(){
                      return [];
                  }
              },
              models:{
                  type: Array,
                  value: function(){
                    return [];
                  }
              },
              currentModel:{
                  type: Object,
                  value:function(){
                    return {};
                  }
              }
          },
          ready:function(){
            //console.log(this._toArray(this.test));
          },
          _toggleSlidersContainer:function(){
              if (this.$.panel.narrow && this.$.panel.getBoundingClientRect().width < parseInt(this.$.panel.responsiveWidth)) {
                    this.$.panel.togglePanel();
              } else {
                    this._toggleForceNarrow();
              }
          },
          _toggleForceNarrow:function(){
              this.$.panel.forceNarrow = !this.$.panel.forceNarrow
              this._toggleIcon();
          },
          _toggleIcon:function(){
             if(this.$.panel.forceNarrow)
               this.iconMenu = "arrow-forward"
             else
               this.iconMenu = "arrow-back"
          },
          _handleResponse:function(e){
              this.models = e.detail.response;
              this._createSliders(this.models);
          },
          _handleError:function(e){
              console.log(e.detail.error);
          },
          _toArray:function(jsonObject){
            if(jsonObject){
              return Object.keys(jsonObject).map(function(key){
                  return {
                      "paramNumber": key,
                      "value": jsonObject[key]
                  }
              });
            }else {
              return null;
            }
          },
          _createSliders:function(models){
              var paramsLength = Object.keys(models[0].params).length;
              for(var i=0;i<paramsLength;i++){
                  this.parametersCollection.push({collection:[]});
              }
              for(var k=0;k<models.length;k++){
                  var jsonArray = this._toArray(models[k].params);
                  for(var j=0;j<jsonArray.length;j++){
                      this.parametersCollection[j].collection.push(jsonArray[j]);
                  }
              }
              this.ready = true;
              this.isLoading = false;
          },
          openModel:function(e){
            this.$.viewer.model = e.currentTarget.model;
            this.$.viewer.openViewer();
          },
          closeModel:function(){
            this.visible = true;
          },
          _findModelById(id){
            for(var i=0;i<this.models.length;i++){
              if(this.models[i].uid == id)
                return this.models[i];
            }
            return null;
          }
      });
      /*
          value:function(){
                      return [
                          {collection:[{"position":10},{"position":30},{"position":50}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                          {collection:[{"position":20},{"position":50},{"position":60}]},
                      ];
                  }

                  <!-- <div class="model-box" id$="{{model.uid}}" on-tap="openModel">
                    <div class="box-title">
                      <h3>{{model.model_name}}</h3>
                    </div>
                    <div class="box-content">
                      <iron-image class="thumbnail"
                                  src="[[model.image]]"
                                ></iron-image>
                    </div>
                  </div>-->
         */
  </script>
</dom-module>
